#!/bin/sh

main () {
  [ ! "$1" ] && usage && exit 1
  [ "$1" = '-h' ] && usage && exit 0

  [ -f "$HOME/.md2gdrc" ] && source "$HOME/.md2gdrc"
  [ -f "$MD2GD_DIR/reference.docx" ] && REFERENCE_DOCX="--reference-docx=$MD2GD_DIR/reference.docx"

  assert_dep 'pandoc'
  assert_dep 'gdrive'

  temp_file=$(mktemp "$1.docx")

  pandoc "$1" --from markdown --to docx "$REFERENCE_DOCX" -o "$temp_file"

  [ $? -ne 0 ] && { printf "md2gd: Conversion failed\n"; rm "$temp_file"; exit 1; }

  doc_id=($(gdrive import "$temp_file" | awk '/Imported/{print $2}'))

  [ $? -ne 0 ] && { printf "md2gd: Import failed\n"; rm "$temp_file"; exit 1; }

  printf "Imported to https://docs.google.com/document/d/%s/edit\n" "$doc_id"

  rm "$temp_file"

  exit 0
}

usage () {
  echo 'usage: md2gd <file>'
}

assert_dep () {
  type "$1" > /dev/null 2>&1
  [ $? -eq 0 ] && return
  [ $? -ne 0 ] && { printf "dependency %s not found\n" "$1"; exit 1; }
}

main "$@"

